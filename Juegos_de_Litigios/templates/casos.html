{% extends "base.html" %}
{% block title %}{{ caso.titulo }} - {{ endpoint | capitalize }}{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2>{{ caso.titulo }}</h2>
    <p><strong>Dificultad:</strong> {{ caso.dificultad }}/10 ({{ "Fácil" if caso.dificultad <= 3 else "Medio" if caso.dificultad <= 7 else "Difícil" }})
        <span class="badge bg-{{ 'success' if caso.dificultad <= 3 else 'warning' if caso.dificultad <= 7 else 'danger' }}"></span>
    </p>
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Hechos</h5>
            <p class="card-text">{{ caso.hechos }}</p>
            <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Pruebas
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse {{ 'show' if caso.dificultad <= 3 else '' }}" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <ul>
                                {% for prueba, detalle in caso.pruebas.items() %}
                                <li>{{ prueba }}: {{ detalle }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Testigos
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse {{ 'show' if caso.dificultad <= 3 else '' }}" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <ul>
                                {% for testigo, detalle in caso.testigos.items() %}
                                <li>{{ testigo }}: {{ detalle }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <h5 class="card-title mt-3">Defensa</h5>
            <p class="card-text">{{ caso.defensa }}</p>
            <h5 class="card-title mt-3">Ley</h5>
            <p class="card-text">{{ caso.ley }}</p>
            <h5 class="card-title mt-3">Procedimiento</h5>
            <p class="card-text">{{ caso.procedimiento }}</p>
            {% if resultado %}
            <div class="alert alert-info mt-3">
                {{ resultado | safe }}
            </div>
            {% endif %}
            <form method="POST" id="alegatoForm">
                <input type="hidden" name="rol" value="Jugador">
                <div class="mb-3">
                    <label for="argumento" class="form-label">Alegato</label>
                    <textarea class="form-control" id="argumento" name="argumento" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Enviar Alegato</button>
            </form>
            <p>Puntos actuales: {{ user_info.points }}</p>
            <a href="{{ url_for(endpoint) }}" class="btn btn-secondary mt-3">Volver</a>
        </div>
    </div>
</div>
<script>
    document.getElementById('alegatoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('{{ url_for("caso", tabla=tabla, caso_id=caso.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams(new FormData(this)).toString()
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert(`Puntos ganados: ${data.puntos}\nEvaluación: ${data.evaluacion}`);
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>
{% endblock %}
